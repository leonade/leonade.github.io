<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf8" />
<meta name="viewport" content="width=device-width">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<!-- <script src="/javascriptTest/jquery.min.js"></script> -->
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:600' rel='stylesheet' type='text/css'>

<style type="text/css">
/*基本信息*/
body{
  height: 100%;
  color: #555;
  font-size: 0.25em;
  font-family: 'Source Sans Pro', sans-serif;
  //margin: 0px;
  text-align: left;
  background: #FFF;
  }
.name{
  font-size: 0.5em;
  }
html, body, #container, #map_canvas {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
}
#map_canvas{
  width: 80%;
  height: 100%;
  position: relative;
  float: left;
  }
#info_canvas{
  width: 20%;
  height: 100%;
  float: right;
  overflow-y: scroll;
  }
</style>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&amp;sensor=false"></script>
<script type="text/javascript" src="src/v3_epoly.js"></script><!-- http://www.geocodezip.com/scripts/v3_epoly.js -->
<script type="text/javascript" src="src/polyline.edit.js"></script><!-- https://github.com/ubilabs/google.maps.polyline.edit -->
<style type="text/css"> 
#map {width: 90%;height: 600px;}
</style> 
<script type='text/javascript'>
function map_initialize() {
  var myLatlng = new google.maps.LatLng(40.4196825873663, -86.8959383306467);
  var myOptions = {
    zoom: 14,
    center: myLatlng,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  }
  map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
}

function size_of_zoom(){
  var size
  var zoom =  map.getZoom();
  if (zoom >= 19) { 
    size = 40
  } 
  else if (zoom <= 15) {
    size = 16
  }
  else{
    size = int(40/Math.pow(1.3,19-zoom))
  }
  return(size)
}

function icon_initialize(){
  //var image = 'icon/'+route['ID']+'.png';
  //var size = 30
  var size = size_of_zoom()
  car_icons = {}
  
  var image = {
    url: 'icon/stop_icon.svg',
    // This marker is 20 pixels wide by 32 pixels high.
    scaledSize : new google.maps.Size(size/2,size/4),
    // The origin for this image is (0, 0).
    origin: new google.maps.Point(0,0),
    // The anchor for this image is the base of the flagpole at (0, 32).
    anchor: new google.maps.Point(size/4,size/8)
  }
  stop_icon = image
  
  routes.forEach(function(route){
    var image = {
      url: 'icon/'+route['ID']+'.png',
      // This marker is 20 pixels wide by 32 pixels high.
      scaledSize : new google.maps.Size(size, size),
      // The origin for this image is (0, 0).
      origin: new google.maps.Point(0, 0),
      // The anchor for this image is the base of the flagpole at (0, 32).
      anchor: new google.maps.Point(size/2, size/2)
    }
    car_icons[route['ID']] = image
  })
  
  google.maps.event.addListener(map,'zoom_changed', function() {
	var zoom =  map.getZoom();
    var size = size_of_zoom()
    for (key in car_icons){
	  car_icons[key].scaledSize = new google.maps.Size(size,size)
	  car_icons[key].anchor = new google.maps.Point(size/2, size/2)
	}
    //stop_icon.scaledSize = new google.maps.Size(size,size/2)
	//stop_icon.anchor = new google.maps.Point(size/2, size/4)
    //for (stop in stops){
	  //stops[stop].marker.setVisible(zoom>16)
	  //stops[stop].marker.setIcon(stop_icon)
	//}
  }) 
}

function encode_route(route){
  var path = google.maps.geometry.encoding.encodePath(route.path.getPath()).replace('\\','\\\\')
  //console.log(path)
  return(path)
}

debug_draw_route = false;

function draw_stop_debug(i, stop){
  if (stop === undefined){	//debugging
	stop = i
    i = 'HereH'
  }
  var stopMarker = new google.maps.Marker({
    draggable: false,
    position: {lat: parseFloat(stops[stop]['Lat']), lng: parseFloat(stops[stop]['Lon'])},
    //label: route['duration'][i].toString(),
    label: i.toString().split("").reverse().join(""),
    stop_id: stop,	  
    //icon: stop_icon,
    visible: debug_draw_route,
    map: map
  });
  stopMarker.addListener('click', function() {
    console.log(stopMarker.stop_id, stopMarker.label)
  });
}

function draw_route(route){
  var decodedPath = google.maps.geometry.encoding.decodePath(route['polyline']);
  var decodedLevels = decodeLevels(Array(decodedPath.length).join("B"));
  //opacity = typeof opacity !== 'undefined' ? opacity : 42
  
  route.path = new google.maps.Polyline({
    path: decodedPath,
    levels: decodedLevels,
    strokeColor: color[route["ID"]],
    strokeOpacity: 1, //0.1
    originalOpacity: 1, //0.1
    strokeWeight: 4,
    map: map,
	route: route	// for click event
  });
  route.path.addListener('click', function() {
    console.log(route.path.route.ID, route.path.route.name)
	routes.forEach(function(route){
	  route.click_activated = false
	  set_route_opacity(route,route.path.originalOpacity)
	})
	route.path.route.click_activated = true
	set_route_opacity(route,1)
	find_car(route.path.route)
  });
  //route.path.edit();
  //console.log(route.ID,route.name,route.stops[0],route.stops[route.stops.length-1]);
  //console.log(route.distance);
  if (debug_draw_route){
    $.each(route.stops, function(i, stop){
      //return
      draw_stop_debug(i, stop)
    })
  }
  //var bounds = new google.maps.LatLngBounds();
  //loc = new google.maps.LatLng("45.478294","9.123949");
  //bounds.extend(loc);
}
function set_route_opacity(route,opacity){
  route.path.setOptions({strokeOpacity:opacity})
}

function draw_stop(stop){
  var stopMarker = new google.maps.Marker({
    draggable: false,
    position: {lat: parseFloat(stops[stop]['Lat']), lng: parseFloat(stops[stop]['Lon'])},
    //label: route['duration'][i].toString(),
    stop_id: stop,  
    icon: stop_icon,
    visible: false,
    map: map
  });
  stopMarker.addListener('click', function() {
    console.log(stopMarker.stop_id)
  });
  stops[stop].marker = stopMarker
}

//cars_marker = []
function draw_car(car){
  //cars[route['name']].forEach(function(car){
    //if(car.marker == undefined){	// new route
      GPosition = car.route.path.GetPointAtDistance(car['loc'])
      var carMarker = new google.maps.Marker({
        map: map,
        position: GPosition, //{lat: GPosition.G, lng: GPosition.K},
        icon: car_icons[car.route['ID']],
        //animation: google.maps.Animation.DROP,
	    draggable: false,
	    visible: false
      });
      car['marker'] = carMarker
	//}
  //})
}

function update(){
  time_stamp = new Date().getTime()
  routes.forEach(function(route){
    route.activated = route.click_activated || route.web_activated
    // update running info ('Running'/'Not Running') every 10 min
    if (time_stamp-route.time_stamp > 600000){
      running_info_initialize();
	  draw_current_routes()
	  current_routes.forEach(find_car);
	}
  })
  // remove arrived cars, set upcoming cars visible
  for (var key in cars){
    $.each(cars[key],function(car_index,car){
      if(car.loc >= car.route.path.Distance()){
        console.log(car.route.ID,car.route.name,'deleted')
        car.marker.visible=false
        delete car.marker
        delete cars[key][car_index]
      }else if(car.running_time >= -1200 && car.route.activated){	// set upcoming cars in 20 min visible
        car.marker.visible=true
      }else if (time_stamp-car.time_stamp > 60000 && car.route.activated){	// update cars location every 1 min
        find_car(car.route);
      }else{
        car.marker.visible=false
      }
    })
	cars[key] = cars[key].filter(function(item){return(item!==undefined)})
  }
}

tick = 1000
function animate() {
  // alert("animate("+d+")");
  update()
  for (var key in cars){
    $.each(cars[key],function(i,car){
	  var p
	  car.loc += car.speed*tick/1000
	  car.running_time += tick/1000
	  p = car.route.path.GetPointAtDistance(car.loc);
      //map.panTo(p);
      car.marker.setPosition(p);
      car.marker.setIcon(car_icons[car.route['ID']]);
	})
  }
  timerHandle = setTimeout(animate, tick);
}

          
//carMarker.setIcon(image)


function decodeLevels(encodedLevelsString) {
  var decodedLevels = [];

  for (var i = 0; i < encodedLevelsString.length; ++i) {
    var level = encodedLevelsString.charCodeAt(i) - 63;
    decodedLevels.push(level);
  }
  return decodedLevels;
}
</script>
<script>
dt = new Date();
//var dt = new Date(2015, 5, 1, 12, 0, 59, 0);
Day = dt.getDay()
//alert(dt2.getFullYear() + ":" + dt2.getMonth() + ":" + dt2.getDate() + ":" + dt2.getDay())
//alert(earlier_than('03:00'))
var over_night = current_earlier_than('03:00')
if(over_night){
  Day = (Day+6)%7
  //alert(Day)
}
function int(num){return(parseInt(num,10))}
function sum(A){return(A.reduce(function(a,b){return(a+b)}))}
function earlier_than(time_str1,time_str2){
  time1 = time_str1.split(':');
  hour1 = int(time1[0]);
  min1 = int(time1[1]);
  time2 = time_str2.split(':');
  hour2 = int(time2[0]);
  min2 = int(time2[1]);
  if(hour1 < hour2){return(true)}
  else if(hour1 > hour2){return(false)}
  else{
    if(min1 < min2){return(true)}
    else if(min1 >= min2){return(false)}
  }
}
//alert('here')
function current_earlier_than(time_str){
  return(earlier_than(dt.getHours()+':'+dt.getMinutes(), time_str))
}

function running_info_initialize(){
  current_routes = [];

  //alert(time + dt.getDay())
  function running(route){
	var operation_day
	var operation_time
	if (Day == 0){
	  operation_day = 'Sunday'
	  operation_time = route.operation_time.Sun
	  if (route.ID == '21'){	// special treatment on Route 21: special hours on Thu-Fri stored in Sun
	    operation_time = ["00:00", "00:00"]
	  }
	}
	else if (Day == 6){
	  operation_day = 'Saturday'
	  operation_time = route.operation_time.Sat
	}
	else {
	  operation_day = 'Weekday'
	  operation_time = route.operation_time.Weekday
	  if ((route.ID == '21') && (Day==4 || Day==5)){	// special treatment on Route 21: special hours on Thu-Fri
	    operation_time = route.operation_time.Sun
	  }
	}
	//operation_info = operation_day+': '+operation_time[0]+' - '+operation_time[1];
	operation_info = operation_time[0]+' - '+operation_time[1];
	// Compare with operation time
	//alert(operation_time)
	// ['0:0','0:0']
	if (operation_time[0] == '00:00'){ return (['No Service', 'on '+operation_day])}
	// late night buses
	else if (earlier_than(operation_time[1], '03:00')){
	  if(over_night){
		if (current_earlier_than(operation_time[1])){ return (['Running', operation_info])}
		else { return (['Not Running', operation_info])}
	  }
	  else{
		if (current_earlier_than(operation_time[0])) { return (['Not Running', operation_info])}
		else { return (['Running', operation_info])}
		}
	}
	// common buses
	else {
	  if(over_night){
		return (['Not Running', operation_info])
	  }
	  else{
		if (!(current_earlier_than(operation_time[0])) && current_earlier_than(operation_time[1])) 
		  {return (['Running', operation_info])}
		else { return (['Not Running', operation_info])}
	  }
	}
  }

  $.each(routes, function(i, route){
	//route_div.innerHTML += "<div class='researcher_name'>" + researcher.researcher_name + "</div>"
	//running(route) 
	running_info = running(route)
	route.status = running_info[0]
	route.operation_info = running_info[1];
	if(route.status == 'Running'){
	  current_routes.push(route);
    }
  });
  
  //return (routes)
}

function draw_current_routes(){
  $.each(routes, function(i, route){
	if(route.path === undefined && !debug_draw_route){
	  draw_route(route)
	}
	if(route.status == 'Running' && !debug_draw_route){
	  set_route_opacity(route,0.4)
	  route.path.originalOpacity = 0.4
	}
	if(route.status == 'Not Running' && !debug_draw_route){
  	  set_route_opacity(route,0.1)
	  route.path.originalOpacity = 0.1
	}
	if(route.status == 'No Service' && !debug_draw_route){
  	  set_route_opacity(route,0)
	  route.path.originalOpacity = 0
	}
  });
}

function convertHex(hex,opacity){
    hex = hex.replace('#','');
    r = parseInt(hex.substring(0,2), 16);
    g = parseInt(hex.substring(2,4), 16);
    b = parseInt(hex.substring(4,6), 16);

    result = 'rgba('+r+','+g+','+b+','+opacity+')';
    return result;
}
function route_gradient(route,highlight){
  if(highlight){
    return('linear-gradient(' + convertHex(color[route.ID],0.75) + ',' + convertHex(color[route.ID],0.85) + ')')
  }else if(route.status == 'Running'){
    return('linear-gradient(' + convertHex(color[route.ID],0.55) + ',' + convertHex(color[route.ID],0.65) + ')')
  }else if(route.status == 'Not Running'){
    return('linear-gradient(' + convertHex(color[route.ID],0.25) + ',' + convertHex(color[route.ID],0.35) + ')')
  }else{
    return('linear-gradient(' + convertHex("#000000",0.35) + ',' + convertHex('#000000',0.45) + ')')
  }
}
function layout_route_info(route){
  var route_div=document.createElement("div");
  route_div.id = route.ID;
  route_div.className = "route";
  route_div.style.background = route_gradient(route,false);
  route_div.addEventListener("click", function(){activate_route(route_div)});
  route_div.innerHTML += "<img class='routeImage' width=\"20\" height=\"20\" style=\"vertical-align:middle\" src=\"icon\\"+route.ID+'.png\">'
  route_div.innerHTML += "<span class='name'>&nbsp;&nbsp;" + route.name.replace(' Inbound','').replace(' Outbound','').replace(' Saturday','').replace(' Weekday','').replace(' Sunday','').replace(' Evening','').replace(' Express AM','').replace(' Express PM','').replace(' North and South','') +  "</span><br/>"
  if(route.status == 'No Service'){
    route_div.innerHTML += "<span class='ID'>No Service&nbsp;" + route.operation_info + "</span><br/>"
  }else{
    route_div.innerHTML += "<span class='ID'>" + route.status + '&nbsp;' + route.operation_info + "</span><br/>"
  }
  return(route_div)
}
function route_info(){
  //temp_routes = routes.slice()
  $("#info_canvas").empty()
  shown_ID = []
  routes.filter(function(route){return(route.status=='Running')}).forEach(function(route){
    if (shown_ID.indexOf(route.ID)<0){
      $("#info_canvas").append(layout_route_info(route));
	  shown_ID.push(route.ID)
	}
  })
  routes.filter(function(route){return(route.status=='Not Running')}).forEach(function(route){
    if (shown_ID.indexOf(route.ID)<0){
      $("#info_canvas").append(layout_route_info(route));
	  shown_ID.push(route.ID)
	}
  })
  routes.filter(function(route){return(route.status=='No Service')}).forEach(function(route){
    if (shown_ID.indexOf(route.ID)<0){
      $("#info_canvas").append(layout_route_info(route));
	  shown_ID.push(route.ID)
	}
  })
}

yql_count = 0
yql_queue = {}
function get_arrival_time(this_stop){
  if(!(this_stop in yql_queue)){
   if(!('arrival_times' in stops[this_stop]) || (new Date().getTime()-stops[this_stop]["arrival_times"].time_stamp > 1000)){
    //console.log(this_stop);
	url = "https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D'http%3A%2F%2Fmyride.gocitybus.com%2Fpublic%2Flaf%2Fweb%2FViewStopNew.aspx%3Fsp%3D"+stops[this_stop]['url']+"%26pt%3D30%26r%3D60'%20and%20xpath%3D'%2F%2F*%5B%40id%3D%22_ctl0_cphMainContent_lookupResults_gvDepartureTimes%22%5D%2Ftbody'&format=json&diagnostics=true&callback="
    query = $.getJSON(url,{},function(response){
      // x=response;
      var time_stamp = new Date().getTime()
      var arrival_times = {time_stamp:time_stamp, arrival:[]}
      $.each(response['query']['results']['tbody']['tr'], function(i,tr){
        if (i >= 1) {
          var r = tr['td'][1]['font']['span']['b']
          var t = tr['td'][3]['font']['span']['content']
          if (t == 'DUE') { t = 0}
          else {t = int(t)*60}
          arrival_times.arrival.push([r,t])
        }
      })
      //console.log(this_stop)
      stops[this_stop]["arrival_times"] = arrival_times;
	  yql_count++;
	  delete yql_queue[this_stop]
    })
	yql_queue[this_stop] = query
	return(query)
   }
  }else{
    return(yql_queue[this_stop])
  }
}

function get_cars_location(route){
  //console.log(this_stop);
  var time_stamp = new Date().getTime()
  var stop_list = route['stops'].slice(0,route['stops'].length-1)
  var arrival_times = []	// arrival times for this route at each stop
  $.each(stop_list, function(i,stop){
    arrival_times.push((stops[stop]['arrival_times']['arrival'].filter(function(arrival){return(arrival[0].indexOf(route['ID']) == 0)}).map(function(arrival){return(arrival[1])})))
  })
  var cars_loc_s = []  // running cars location (seconds from final stop) for this route
  arrival_times[0].forEach(function(at){cars_loc_s.push({arrival_stop:0,time:[at]})})
  for(stop_index = 1; stop_index < arrival_times.length; stop_index++){
    //console.log(stop_index)
    if (arrival_times[stop_index].length >0){
      cars_loc_s.map(function(car){
	    car.time = car.time.map(function(at){
	      return(at+route['duration'][stop_index])
	    })
	  })  // get the arrival time at next stop
	}
    for(arrival_index=0; arrival_index < arrival_times[stop_index].length; arrival_index++){
      var match = false
      var at = arrival_times[stop_index][arrival_index]
      var car_index = 0
      while(!match && car_index < cars_loc_s.length){
        cars_loc_s[car_index].time.some(function(car_time){
          if(Math.abs(car_time - at)<=240){
            match = true
            cars_loc_s[car_index].time.push(at)
            return(true)
          }
        })
        car_index++
      }
      if(!match){
        cars_loc_s.push({arrival_stop:stop_index,time:[at]})
      }
    }
  }
  var cars_loc_m = []
  cars_loc_s.map(function(car){
    //if(car.arrival_stop==0){return}  // filter not departured cars
    if(car.time.length<arrival_times.slice(car.arrival_stop).filter(function(ar){return(ar.length)}).length-1){return}  // filter cross-stops on double way
    dist = 0
	speed = 0
	running_time = sum(route.duration) - sum(car.time)/car.time.length
    route['distance'].slice(0,car.arrival_stop).map(function(d){dist+=d})
    if(arrival_times[car.arrival_stop][0]==0){  // DUE on arrival_stop
      dist += route['distance'][car.arrival_stop]
	  speed = 0
    }else{
      if(arrival_times[car.arrival_stop][0] <= route['duration'][car.arrival_stop]){
        dist += route['distance'][car.arrival_stop] * (1-arrival_times[car.arrival_stop][0]/route['duration'][car.arrival_stop])
		speed = route['distance'][car.arrival_stop] / arrival_times[car.arrival_stop][0]
      }else{
	    dist += route['distance'][car.arrival_stop] * (1-1)
		speed = route['distance'][car.arrival_stop] / arrival_times[car.arrival_stop][0]
	  }
    }
    cars_loc_m.push({route:route,loc:dist,speed:speed,running_time:running_time,time_stamp:time_stamp})
  })
  return(cars_loc_m)
}

function find_car(route){
  //console.log(route['name']);
  //$.each(route['stops'],function(i, this_stop)  {get_arrival_time(this_stop)})
  //if(route['name']=='Salisbury Evening Saturday Inbound'){
  x = route
  var promises = []
  $.each(route['stops'], function(i,this_stop) { promises.push(get_arrival_time(this_stop))})
  $.when.apply($, promises).then(function() {
    new_cars = get_cars_location(route)
	if(cars[route['name']]=== undefined){
	  cars[route['name']] = new_cars
	  new_cars.forEach(draw_car)
	}else{
	  new_cars.forEach(function(new_car){// push car status
	    is_new = true
        $.each(cars[route['name']], function(car_index,car){
	      if(Math.abs(car.running_time - new_car.running_time)<=240){
		    is_new = false
			if(cars[route['name']][car_index].loc < new_car.loc){
			  cars[route['name']][car_index].loc = new_car.loc
			}
			cars[route['name']][car_index].speed = new_car.speed
			cars[route['name']][car_index].running_time = new_car.running_time
			cars[route['name']][car_index].time_stamp = new_car.time_stamp
		    //return(true)
		  }
	    })
	    if(is_new){
		  draw_car(new_car)
	      cars[route['name']].push(new_car)
	    }
	  })
    }
	//draw_cars(route)
  })
}

function activate_route(route_div){
  console.log(route_div.id)
  routes.forEach(function(route){
    if(route.ID == route_div.id){
      route.web_activated = !route.web_activated
	  if(route.web_activated){
        find_car(route);
		route_div.style.background = route_gradient(route,true);
		route_div.style.color = '#eee';
	    set_route_opacity(route,1)
	  }else{
		route_div.style.background = route_gradient(route,false);
		route_div.style.color = '#555';
	    set_route_opacity(route,route.path.originalOpacity)
	  }
	}
  })
}


</script>


<script>
var routes;    // list
current_routes = [];    // list
var stops;    // dict
var x;
cars = []
color = {"1A":'#0575cb',"1B":'#0575cb',"2A":"#e4142c","2B":"#e4142c","3":"#5e2c85","4A":"#669933","4B":"#669933","5A":"#e15822","5B":"#e15822","6A":"#f0436e","6B":"#f0436e","7":"#f4a91a","8":"#00afad","12":"#df8f1c","13":"#a0a0a0","14":"#231f20","15":"#f06b1e","16":"#995727","17":"#0099ff","18":"#272063","19":"#d13632","20":"#b02491","21":"#8dc83f","23":"#00AA59","27":"#55B340"}
$(document).ready(function(){
  map_initialize();
  $.getJSON("/data/stops.json",{},function(Stops){
    stops = Stops
	for(stop in stops){
	  stops[stop].activated = false
	}
  });
  //stops = getJSON("/data/stops.json")
  //$.ajax({
    //url: "/data/stops.json",
   	//async: false,
   	//dataType: 'json',
   	//success: function(Stops){stops = Stops}
  //});
  //$.getJSON("/data/routes.json",{},function current(Routes){
  
  $.getJSON("/data/routes.json",{},function(Routes){
    routes = Routes;
	routes.forEach(function(route){
	  route.activated = false;
	  route.click_activated = false;
	  route.web_activated = false;
    })
    icon_initialize();
    running_info_initialize();
	draw_current_routes();
	route_info()
    
	current_routes.forEach(find_car);	// TODO
    //setTimeout(animate, 5000);
	animate()
  });
  //running_info_initialize(getJSON("/data/routes.json"))
  //$.ajax({
    //url: "/data/routes.json",
   	//async: false,
   	//dataType: 'json',
   	//success: function(Routes) {running_info_initialize(Routes)}});
  
  //console.log(routes);
});


</script>
</head>

<body> 
<div id="container"><!-- 页面层容器 -->
  <div id="map_canvas"></div>
  <div id="info_canvas"></div>
  <!-- <div id="Footer">页面底部</div> -->
</div>
</body> 
</body>
</html>


</head> 
</html>